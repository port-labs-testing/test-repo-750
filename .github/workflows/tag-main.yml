name: Tag main branch
on:
  push:
    branches:
      - main
      - feat-add-prev-tag-check-debug
    paths:
      - 'pyproject.toml'
      

jobs:
  tag-main:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Get current version
        id: get_current_version
        run: |
          # Get the current version from pyproject.toml
          CURRENT_TAG=$(grep -E '^version = ".*"' pyproject.toml | cut -d'"' -f2)
          echo "current_tag=$CURRENT_TAG" >> $GITHUB_ENV

      - name: Get previous version
        id: get_previous_version
        run: |
          # Get the version from the previous commit for comparison
          PREV_TAG=$(git show HEAD~1:pyproject.toml | grep -E '^version = ".*"' | cut -d'"' -f2)
          echo "prev_tag=$PREV_TAG" >> $GITHUB_ENV

      - name: Setup tmate session
        uses: mxschmitt/action-tmate@v3

      - name: Check if version changed
        id: version_check
        run: |
          if [ "$CURRENT_TAG" == "$PREV_TAG" ]; then
            echo "Version has not changed. Skipping tagging."
            exit 0
          fi

      - name: Tag main
        if: steps.version_check.outcome == 'success'
        run: |
          git tag "v${CURRENT_TAG}"
          git push origin main --tags
